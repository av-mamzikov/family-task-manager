name: Deploy to VPS

on:
  # –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –Ω–∞ main/master
  workflow_run:
    workflows: [ "Tests" ]
    types:
      - completed
    branches:
      - main
      - master
  # PR —Å –ª–µ–π–±–ª–æ–º deploy-preview
  pull_request:
    types: [ labeled, synchronize, opened, reopened ]
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - pr-preview
        default: 'production'
      pr_number:
        description: 'PR number (required only for pr-preview)'
        required: false
        type: string

jobs:
  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    # –ó–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏:
    # - workflow_dispatch (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫) - –≤—Å–µ–≥–¥–∞
    # - workflow_run (–ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤) - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω—ã
    # - pull_request —Å –ª–µ–π–±–ª–æ–º deploy-preview - –≤—Å–µ–≥–¥–∞
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy-preview'))
    outputs:
      is_production: ${{ steps.env.outputs.is_production }}
      is_pr_preview: ${{ steps.env.outputs.is_pr_preview }}
      pr_number: ${{ steps.env.outputs.pr_number }}
      image_tag: ${{ steps.env.outputs.image_tag }}
      deploy_dir: ${{ steps.env.outputs.deploy_dir }}
      bot_token_secret: ${{ steps.env.outputs.bot_token_secret }}
      bot_username_secret: ${{ steps.env.outputs.bot_username_secret }}
      postgres_user_secret: ${{ steps.env.outputs.postgres_user_secret }}
      postgres_password_secret: ${{ steps.env.outputs.postgres_password_secret }}
    
    steps:
      - name: Determine environment
        id: env
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV_TYPE="${{ inputs.environment }}"
            PR_NUM="${{ inputs.pr_number }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR —Å –ª–µ–π–±–ª–æ–º deploy-preview
            ENV_TYPE="pr-preview"
            PR_NUM="${{ github.event.pull_request.number }}"
          else
            # workflow_run - –≤—Å–µ–≥–¥–∞ production
            ENV_TYPE="production"
            PR_NUM=""
          fi
          
          echo "Environment type: $ENV_TYPE"
          echo "PR number: $PR_NUM"
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏
          if [ "$ENV_TYPE" == "production" ]; then
            echo "is_production=true" >> $GITHUB_OUTPUT
            echo "is_pr_preview=false" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "image_tag=latest" >> $GITHUB_OUTPUT
            echo "deploy_dir=/opt/family-task-manager" >> $GITHUB_OUTPUT
            echo "bot_token_secret=TELEGRAM_BOT_TOKEN" >> $GITHUB_OUTPUT
            echo "bot_username_secret=TELEGRAM_BOT_USERNAME" >> $GITHUB_OUTPUT
            echo "postgres_user_secret=POSTGRES_USER" >> $GITHUB_OUTPUT
            echo "postgres_password_secret=POSTGRES_PASSWORD" >> $GITHUB_OUTPUT
          else
            # PR Preview - –≤—Å–µ PR –≤ –æ–¥–Ω—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            if [ -z "$PR_NUM" ]; then
              echo "Error: PR number required for pr-preview environment"
              exit 1
            fi
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "is_pr_preview=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "image_tag=pr-$PR_NUM" >> $GITHUB_OUTPUT
            echo "deploy_dir=/opt/family-task-manager-preview" >> $GITHUB_OUTPUT
            echo "bot_token_secret=PR_BOT_TOKEN" >> $GITHUB_OUTPUT
            echo "bot_username_secret=PR_BOT_USERNAME" >> $GITHUB_OUTPUT
            echo "postgres_user_secret=PR_POSTGRES_USER" >> $GITHUB_OUTPUT
            echo "postgres_password_secret=PR_POSTGRES_PASSWORD" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    name: Build and Push to Registry
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup SSH tunnel to Private Registry
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
          # –ó–∞–ø—É—Å–∫ SSH —Ç—É–Ω–Ω–µ–ª—è –≤ —Ñ–æ–Ω–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ registry
          ssh -f -N -L 5000:localhost:5000 ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}
          
          # –ñ–¥–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—É–Ω–Ω–µ–ª—è
          sleep 5

      - name: Login to Private Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login localhost:5000 -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ registry –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
          curl -u ${{ secrets.REGISTRY_USERNAME }}:${{ secrets.REGISTRY_PASSWORD }} -f http://localhost:5000/v2/_catalog || (echo "Registry unavailable" && exit 1)
          echo "‚úì Registry is available and authenticated"

      - name: Extract metadata
        id: meta
        run: |
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "pr_number=${{ needs.setup.outputs.pr_number }}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        env:
          IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
          IS_PR_PREVIEW: ${{ needs.setup.outputs.is_pr_preview }}
        run: |
          REGISTRY_HOST="localhost:5000"
          IMAGE_NAME="family-task-manager"
          COMMIT_HASH="${{ steps.meta.outputs.commit_hash }}"
          BRANCH="${{ steps.meta.outputs.branch }}"
          BUILD_DATE="${{ steps.meta.outputs.build_date }}"
          PR_NUMBER="${{ steps.meta.outputs.pr_number }}"
          
          # –ë–∞–∑–æ–≤—ã–µ —Ç–µ–≥–∏
          TAGS="--tag $REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG"
          TAGS="$TAGS --tag $REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG-$COMMIT_HASH"
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –¥–ª—è production
          if [ "$IS_PR_PREVIEW" == "false" ]; then
            TAGS="$TAGS --tag $REGISTRY_HOST/$IMAGE_NAME:$BRANCH"
          fi
          
          # –°–±–æ—Ä–∫–∞
          docker build \
            --build-arg BUILD_CONFIGURATION=Release \
            --label "git.commit=$COMMIT_HASH" \
            --label "git.branch=$BRANCH" \
            --label "git.pr=$PR_NUMBER" \
            --label "build.date=$BUILD_DATE" \
            --label "environment=${{ needs.setup.outputs.is_production == 'true' && 'production' || 'pr-preview' }}" \
            $TAGS \
            -f ./Dockerfile .
          
          # Push –≤—Å–µ—Ö —Ç–µ–≥–æ–≤
          docker push "$REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG"
          docker push "$REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG-$COMMIT_HASH"
          
          if [ "$IS_PR_PREVIEW" == "false" ]; then
            docker push "$REGISTRY_HOST/$IMAGE_NAME:$BRANCH"
          fi
          
          echo "‚úì Pushed images:"
          echo "  - $REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG"
          echo "  - $REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG-$COMMIT_HASH"
          if [ "$IS_PR_PREVIEW" == "false" ]; then
            echo "  - $REGISTRY_HOST/$IMAGE_NAME:$BRANCH"
          fi

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [ setup, build-and-push ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy docker-compose.prod.yml to VPS
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
          # –ö–æ–ø–∏—Ä—É–µ–º docker-compose.prod.yml –Ω–∞ VPS
          scp -i ~/.ssh/id_rsa docker-compose.prod.yml ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/tmp/docker-compose.prod.yml

      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.0
        env:
          DEPLOY_DIR: ${{ needs.setup.outputs.deploy_dir }}
          IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
          IS_PRODUCTION: ${{ needs.setup.outputs.is_production }}
          IS_PR_PREVIEW: ${{ needs.setup.outputs.is_pr_preview }}
          PR_NUMBER: ${{ needs.setup.outputs.pr_number }}
          BOT_TOKEN: ${{ secrets[needs.setup.outputs.bot_token_secret] }}
          BOT_USERNAME: ${{ secrets[needs.setup.outputs.bot_username_secret] }}
          POSTGRES_USER: ${{ secrets[needs.setup.outputs.postgres_user_secret] }}
          POSTGRES_PASSWORD: ${{ secrets[needs.setup.outputs.postgres_password_secret] }}
          REGISTRY_USER: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASS: ${{ secrets.REGISTRY_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DEPLOY_DIR,IMAGE_TAG,IS_PRODUCTION,IS_PR_PREVIEW,PR_NUMBER,BOT_TOKEN,BOT_USERNAME,POSTGRES_USER,POSTGRES_PASSWORD,REGISTRY_USER,REGISTRY_PASS
          script: |
            echo "=== Starting deployment ==="
            echo "Environment: $([ "$IS_PRODUCTION" == "true" ] && echo "Production" || echo "PR Preview #$PR_NUMBER")"
            echo "Deploy directory: $DEPLOY_DIR"
            echo "Image tag: $IMAGE_TAG"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ registry —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
            if ! curl -u "$REGISTRY_USER:$REGISTRY_PASS" -sf http://localhost:5000/v2/_catalog > /dev/null; then
              echo "‚úó Error: Registry is not available"
              exit 1
            fi
            echo "‚úì Registry is available"
            
            # –õ–æ–≥–∏–Ω –≤ registry –¥–ª—è docker pull
            echo "$REGISTRY_PASS" | docker login localhost:5000 -u "$REGISTRY_USER" --password-stdin
            echo "‚úì Logged in to registry"
            
            # –î–ª—è PR preview: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            if [ "$IS_PR_PREVIEW" == "true" ]; then
              echo "Cleaning up old PR preview environment..."
            
              # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã preview
              docker ps -a --filter "name=family-task-manager-pr-" --format "{{.Names}}" | xargs -r docker stop
              docker ps -a --filter "name=family-task-manager-pr-" --format "{{.Names}}" | xargs -r docker rm
              docker ps -a --filter "name=family-task-postgres-pr-" --format "{{.Names}}" | xargs -r docker stop
              docker ps -a --filter "name=family-task-postgres-pr-" --format "{{.Names}}" | xargs -r docker rm
            
              # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ volumes preview
              docker volume ls --filter "name=postgres_data_pr_" --format "{{.Name}}" | xargs -r docker volume rm || true
            
              # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–µ—Ç–∏ preview
              docker network ls --filter "name=family-task-network-pr-" --format "{{.Name}}" | xargs -r docker network rm || true
            
              echo "‚úì Old PR preview cleaned up"
            fi
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown $USER:$USER "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ docker-compose.prod.yml –∏–∑ /tmp
            echo "Copying docker-compose.prod.yml..."
            cp /tmp/docker-compose.prod.yml ./docker-compose.prod.yml
            
            # –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞
            echo "Creating .env file..."
            cat > .env << EOF
            # Environment: $([ "$IS_PRODUCTION" == "true" ] && echo "Production" || echo "PR Preview #$PR_NUMBER")
            REGISTRY_HOST=localhost:5000
            REGISTRY_TAG=$IMAGE_TAG
            
            # PostgreSQL
            POSTGRES_USER=$POSTGRES_USER
            POSTGRES_PASSWORD=$POSTGRES_PASSWORD
            POSTGRES_DB=$([ "$IS_PRODUCTION" == "true" ] && echo "FamilyTaskManager" || echo "FamilyTaskManager_PR_$PR_NUMBER")
            
            # Telegram Bot
            TELEGRAM_BOT_TOKEN=$BOT_TOKEN
            TELEGRAM_BOT_USERNAME=$BOT_USERNAME
            
            # Application
            ASPNETCORE_ENVIRONMENT=$([ "$IS_PRODUCTION" == "true" ] && echo "Production" || echo "Staging")
            TZ=Europe/Moscow
            EOF
            
            # –î–ª—è PR preview: –æ–±–Ω–æ–≤–ª—è–µ–º –∏–º–µ–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —Å–µ—Ç–µ–π
            if [ "$IS_PR_PREVIEW" == "true" ]; then
              echo "Configuring PR preview environment..."
            
              # –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π docker-compose —Ñ–∞–π–ª
              # –ù–ï –º–µ–Ω—è–µ–º –∏–º—è –æ–±—Ä–∞–∑–∞, —Ç–æ–ª—å–∫–æ –∏–º–µ–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —Å–µ—Ç–µ–π
              sed "s/container_name: family-task-manager/container_name: family-task-manager-pr-$PR_NUMBER/g" docker-compose.prod.yml | \
              sed "s/container_name: family-task-postgres/container_name: family-task-postgres-pr-$PR_NUMBER/g" | \
              sed "s/family-task-network/family-task-network-pr-$PR_NUMBER/g" | \
              sed "s/postgres_data:/postgres_data_pr_$PR_NUMBER:/g" > docker-compose.pr.yml
            
              COMPOSE_FILE="docker-compose.pr.yml"
              CONTAINER_NAME="family-task-manager-pr-$PR_NUMBER"
            else
              COMPOSE_FILE="docker-compose.prod.yml"
              CONTAINER_NAME="family-task-manager"
            fi
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ë–î (—Ç–æ–ª—å–∫–æ –¥–ª—è production)
            if [ "$IS_PRODUCTION" == "true" ]; then
              BACKUP_DIR="/opt/backups/family-task-manager"
              sudo mkdir -p "$BACKUP_DIR"
              sudo chown $USER:$USER "$BACKUP_DIR"
              BACKUP_FILE="$BACKUP_DIR/db_backup_$(date +%Y%m%d_%H%M%S).sql"
              docker exec family-task-postgres pg_dump -U "$POSTGRES_USER" FamilyTaskManager > "$BACKUP_FILE" 2>/dev/null || echo "Warning: Could not create backup"
            fi
            
            # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
            echo "Pulling image: localhost:5000/family-task-manager:$IMAGE_TAG"
            docker pull "localhost:5000/family-task-manager:$IMAGE_TAG"
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            echo "Stopping old container..."
            docker compose -f "$COMPOSE_FILE" stop "$CONTAINER_NAME" 2>/dev/null || true
            docker compose -f "$COMPOSE_FILE" rm -f "$CONTAINER_NAME" 2>/dev/null || true
            
            # –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            echo "Starting new container..."
            docker compose -f "$COMPOSE_FILE" up -d
            
            # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
            sleep 10
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            echo ""
            echo "Container status:"
            docker compose -f "$COMPOSE_FILE" ps
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
            echo ""
            echo "Recent logs:"
            docker compose -f "$COMPOSE_FILE" logs --tail=30 "$CONTAINER_NAME"
            
            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            echo ""
            echo "Cleaning up old images..."
            docker image prune -f
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            if docker compose -f "$COMPOSE_FILE" ps | grep -q "$CONTAINER_NAME.*Up"; then
              echo ""
              echo "‚úì Deployment successful!"
              if [ "$IS_PR_PREVIEW" == "true" ]; then
                echo "  PR Preview #$PR_NUMBER is running"
                echo "  Bot: @$BOT_USERNAME"
                echo "  Container: $CONTAINER_NAME"
              fi
            else
              echo ""
              echo "‚úó Deployment failed!"
              exit 1
            fi

      - name: Comment on PR (if PR preview)
        if: needs.setup.outputs.is_pr_preview == 'true' && needs.setup.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.setup.outputs.pr_number }};
            const imageTag = '${{ needs.setup.outputs.image_tag }}';
            const botUsername = '${{ secrets[needs.setup.outputs.bot_username_secret] }}';
            
            const comment = `## üöÄ PR Preview Environment Deployed
            
            Your changes have been deployed to a preview environment!
            
            **Environment Details:**
            - ü§ñ **Telegram Bot:** \`@${botUsername}\`
            - üê≥ **Container:** \`family-task-manager-pr-${prNumber}\`
            - üóÑÔ∏è **Database:** \`FamilyTaskManager_PR_${prNumber}\`
            - üè∑Ô∏è **Image Tag:** \`${imageTag}\`
            - üì¶ **Registry:** \`localhost:5000/family-task-manager:${imageTag}\`
            
            **How to test:**
            1. Open Telegram
            2. Find bot \`@${botUsername}\`
            3. Send \`/start\`
            4. Test your changes
            
            **View logs:**
            \`\`\`bash
            ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}
            docker logs family-task-manager-pr-${prNumber} -f
            \`\`\`
            
            **To update:** Push new commits to this PR
            
            **To cleanup:** Close this PR or run cleanup workflow manually
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
