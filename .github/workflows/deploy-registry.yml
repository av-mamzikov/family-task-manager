name: Deploy to VPS

on:
  # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ½Ğ° main/master
  workflow_run:
    workflows: [ "Tests" ]
    types:
      - completed
    branches:
      - main
      - master
  # PR Ñ Ğ»ĞµĞ¹Ğ±Ğ»Ğ¾Ğ¼ deploy-preview
  pull_request:
    types: [ labeled, synchronize, opened, reopened ]
  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - pr-preview
        default: 'production'
      pr_number:
        description: 'PR number (required only for pr-preview)'
        required: false
        type: string

jobs:
  # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµÑĞ»Ğ¸:
    # - workflow_dispatch (Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº) - Ğ²ÑĞµĞ³Ğ´Ğ°
    # - workflow_run (Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²) - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ñ‚ĞµÑÑ‚Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹
    # - pull_request Ñ Ğ»ĞµĞ¹Ğ±Ğ»Ğ¾Ğ¼ deploy-preview - Ğ²ÑĞµĞ³Ğ´Ğ°
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy-preview'))
    outputs:
      is_production: ${{ steps.env.outputs.is_production }}
      is_pr_preview: ${{ steps.env.outputs.is_pr_preview }}
      pr_number: ${{ steps.env.outputs.pr_number }}
      image_tag: ${{ steps.env.outputs.image_tag }}
      deploy_dir: ${{ steps.env.outputs.deploy_dir }}
      bot_token_secret: ${{ steps.env.outputs.bot_token_secret }}
      bot_username_secret: ${{ steps.env.outputs.bot_username_secret }}
      postgres_user_secret: ${{ steps.env.outputs.postgres_user_secret }}
      postgres_password_secret: ${{ steps.env.outputs.postgres_password_secret }}
    
    steps:
      - name: Determine environment
        id: env
        run: |
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV_TYPE="${{ inputs.environment }}"
            PR_NUM="${{ inputs.pr_number }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR Ñ Ğ»ĞµĞ¹Ğ±Ğ»Ğ¾Ğ¼ deploy-preview
            ENV_TYPE="pr-preview"
            PR_NUM="${{ github.event.pull_request.number }}"
          else
            # workflow_run - Ğ²ÑĞµĞ³Ğ´Ğ° production
            ENV_TYPE="production"
            PR_NUM=""
          fi
          
          echo "Environment type: $ENV_TYPE"
          echo "PR number: $PR_NUM"
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³Ğ¸
          if [ "$ENV_TYPE" == "production" ]; then
            echo "is_production=true" >> $GITHUB_OUTPUT
            echo "is_pr_preview=false" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "image_tag=latest" >> $GITHUB_OUTPUT
            echo "deploy_dir=/opt/family-task-manager" >> $GITHUB_OUTPUT
            echo "bot_token_secret=TELEGRAM_BOT_TOKEN" >> $GITHUB_OUTPUT
            echo "bot_username_secret=TELEGRAM_BOT_USERNAME" >> $GITHUB_OUTPUT
            echo "postgres_user_secret=POSTGRES_USER" >> $GITHUB_OUTPUT
            echo "postgres_password_secret=POSTGRES_PASSWORD" >> $GITHUB_OUTPUT
          else
            # PR Preview - Ğ²ÑĞµ PR Ğ² Ğ¾Ğ´Ğ½Ñƒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
            if [ -z "$PR_NUM" ]; then
              echo "Error: PR number required for pr-preview environment"
              exit 1
            fi
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "is_pr_preview=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "image_tag=pr-$PR_NUM" >> $GITHUB_OUTPUT
            echo "deploy_dir=/opt/family-task-manager-preview" >> $GITHUB_OUTPUT
            echo "bot_token_secret=PR_BOT_TOKEN" >> $GITHUB_OUTPUT
            echo "bot_username_secret=PR_BOT_USERNAME" >> $GITHUB_OUTPUT
            echo "postgres_user_secret=PR_POSTGRES_USER" >> $GITHUB_OUTPUT
            echo "postgres_password_secret=PR_POSTGRES_PASSWORD" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    name: Build and Push to Registry
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup SSH tunnel to Private Registry
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº SSH Ñ‚ÑƒĞ½Ğ½ĞµĞ»Ñ Ğ² Ñ„Ğ¾Ğ½Ğµ Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº registry
          ssh -f -N -L 5000:localhost:5000 ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}
          
          # Ğ–Ğ´ĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ñ‚ÑƒĞ½Ğ½ĞµĞ»Ñ
          sleep 5

      - name: Login to Private Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login localhost:5000 -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ registry Ğ¿Ğ¾ÑĞ»Ğµ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°
          curl -u ${{ secrets.REGISTRY_USERNAME }}:${{ secrets.REGISTRY_PASSWORD }} -f http://localhost:5000/v2/_catalog || (echo "Registry unavailable" && exit 1)
          echo "âœ“ Registry is available and authenticated"

      - name: Extract metadata
        id: meta
        run: |
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "pr_number=${{ needs.setup.outputs.pr_number }}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        env:
          IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
          IS_PR_PREVIEW: ${{ needs.setup.outputs.is_pr_preview }}
        run: |
          REGISTRY_HOST="localhost:5000"
          IMAGE_NAME="family-task-manager"
          COMMIT_HASH="${{ steps.meta.outputs.commit_hash }}"
          BRANCH="${{ steps.meta.outputs.branch }}"
          BUILD_DATE="${{ steps.meta.outputs.build_date }}"
          PR_NUMBER="${{ steps.meta.outputs.pr_number }}"
          
          # Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ñ‚ĞµĞ³Ğ¸
          TAGS="--tag $REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG"
          TAGS="$TAGS --tag $REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG-$COMMIT_HASH"
          
          # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ‚ĞµĞ³Ğ¸ Ğ´Ğ»Ñ production
          if [ "$IS_PR_PREVIEW" == "false" ]; then
            TAGS="$TAGS --tag $REGISTRY_HOST/$IMAGE_NAME:$BRANCH"
          fi
          
          # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°
          docker build \
            --build-arg BUILD_CONFIGURATION=Release \
            --label "git.commit=$COMMIT_HASH" \
            --label "git.branch=$BRANCH" \
            --label "git.pr=$PR_NUMBER" \
            --label "build.date=$BUILD_DATE" \
            --label "environment=${{ needs.setup.outputs.is_production == 'true' && 'production' || 'pr-preview' }}" \
            $TAGS \
            -f ./Dockerfile .
          
          # Push Ğ²ÑĞµÑ… Ñ‚ĞµĞ³Ğ¾Ğ²
          docker push "$REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG"
          docker push "$REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG-$COMMIT_HASH"
          
          if [ "$IS_PR_PREVIEW" == "false" ]; then
            docker push "$REGISTRY_HOST/$IMAGE_NAME:$BRANCH"
          fi
          
          echo "âœ“ Pushed images:"
          echo "  - $REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG"
          echo "  - $REGISTRY_HOST/$IMAGE_NAME:$IMAGE_TAG-$COMMIT_HASH"
          if [ "$IS_PR_PREVIEW" == "false" ]; then
            echo "  - $REGISTRY_HOST/$IMAGE_NAME:$BRANCH"
          fi

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [ setup, build-and-push ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy docker-compose.prod.yml to VPS
        env:
          DEPLOY_DIR: ${{ needs.setup.outputs.deploy_dir }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ° VPS ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
          ssh -i ~/.ssh/id_rsa ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "sudo mkdir -p $DEPLOY_DIR && sudo chown \$USER:\$USER $DEPLOY_DIR"
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ docker-compose.prod.yml ÑÑ€Ğ°Ğ·Ñƒ ĞºĞ°Ğº docker-compose.yml
          scp -i ~/.ssh/id_rsa docker-compose.prod.yml ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:$DEPLOY_DIR/docker-compose.yml

      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.0
        env:
          DEPLOY_DIR: ${{ needs.setup.outputs.deploy_dir }}
          IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
          IS_PRODUCTION: ${{ needs.setup.outputs.is_production }}
          IS_PR_PREVIEW: ${{ needs.setup.outputs.is_pr_preview }}
          PR_NUMBER: ${{ needs.setup.outputs.pr_number }}
          BOT_TOKEN: ${{ secrets[needs.setup.outputs.bot_token_secret] }}
          BOT_USERNAME: ${{ secrets[needs.setup.outputs.bot_username_secret] }}
          POSTGRES_USER: ${{ secrets[needs.setup.outputs.postgres_user_secret] }}
          POSTGRES_PASSWORD: ${{ secrets[needs.setup.outputs.postgres_password_secret] }}
          REGISTRY_USER: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASS: ${{ secrets.REGISTRY_PASSWORD }}
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DEPLOY_DIR,IMAGE_TAG,IS_PRODUCTION,IS_PR_PREVIEW,PR_NUMBER,BOT_TOKEN,BOT_USERNAME,POSTGRES_USER,POSTGRES_PASSWORD,REGISTRY_USER,REGISTRY_PASS,DOCKERHUB_USER,DOCKERHUB_PASS
          script: |
            echo "=== Starting deployment ==="
            echo "Environment: $([ "$IS_PRODUCTION" == "true" ] && echo "Production" || echo "PR Preview #$PR_NUMBER")"
            echo "Deploy directory: $DEPLOY_DIR"
            echo "Image tag: $IMAGE_TAG"
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ registry Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸ĞµĞ¹
            if ! curl -u "$REGISTRY_USER:$REGISTRY_PASS" -sf http://localhost:5000/v2/_catalog > /dev/null; then
              echo "âœ— Error: Registry is not available"
              exit 1
            fi
            echo "âœ“ Registry is available"
            
            # Ğ›Ğ¾Ğ³Ğ¸Ğ½ Ğ² Docker Hub (ĞµÑĞ»Ğ¸ credentials Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ñ‹)
            if [ -n "$DOCKERHUB_USER" ] && [ -n "$DOCKERHUB_PASS" ]; then
              echo "Logging in to Docker Hub..."
              echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
              echo "âœ“ Logged in to Docker Hub"
            else
              echo "âš  Docker Hub credentials not provided, using anonymous pulls"
            fi
            
            # Ğ›Ğ¾Ğ³Ğ¸Ğ½ Ğ² registry Ğ´Ğ»Ñ docker pull
            echo "$REGISTRY_PASS" | docker login localhost:5000 -u "$REGISTRY_USER" --password-stdin
            echo "âœ“ Logged in to registry"
            
            # Ğ”Ğ»Ñ PR preview: Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
            if [ "$IS_PR_PREVIEW" == "true" ]; then
              echo "Cleaning up old PR preview environment..."
            
              # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¸ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ preview
              docker ps -a --filter "name=family-task-manager-pr-" --format "{{.Names}}" | xargs -r docker stop
              docker ps -a --filter "name=family-task-manager-pr-" --format "{{.Names}}" | xargs -r docker rm
              docker ps -a --filter "name=family-task-postgres-pr-" --format "{{.Names}}" | xargs -r docker stop
              docker ps -a --filter "name=family-task-postgres-pr-" --format "{{.Names}}" | xargs -r docker rm
            
              # Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ volumes preview
              docker volume ls --filter "name=postgres_data_pr_" --format "{{.Name}}" | xargs -r docker volume rm || true
            
              # Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ÑĞµÑ‚Ğ¸ preview
              docker network ls --filter "name=family-task-network-pr-" --format "{{.Name}}" | xargs -r docker network rm || true
            
              echo "âœ“ Old PR preview cleaned up"
            fi
            
            # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
            cd "$DEPLOY_DIR"
            
            # docker-compose.yml ÑƒĞ¶Ğµ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ° Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¼ ÑˆĞ°Ğ³Ğµ
            echo "âœ“ docker-compose.yml is ready"
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ğ°
            echo "Creating .env file..."
            cat > .env << EOF
            # Environment: $([ "$IS_PRODUCTION" == "true" ] && echo "Production" || echo "PR Preview #$PR_NUMBER")
            REGISTRY_HOST=localhost:5000
            REGISTRY_TAG=$IMAGE_TAG
            
            # PostgreSQL
            POSTGRES_USER=$POSTGRES_USER
            POSTGRES_PASSWORD=$POSTGRES_PASSWORD
            POSTGRES_DB=$([ "$IS_PRODUCTION" == "true" ] && echo "FamilyTaskManager" || echo "FamilyTaskManager_PR_$PR_NUMBER")
            
            # Telegram Bot
            TELEGRAM_BOT_TOKEN=$BOT_TOKEN
            TELEGRAM_BOT_USERNAME=$BOT_USERNAME
            
            # Application
            ASPNETCORE_ENVIRONMENT=$([ "$IS_PRODUCTION" == "true" ] && echo "Production" || echo "Staging")
            TZ=Europe/Moscow
            EOF
            
            # Ğ”Ğ»Ñ PR preview: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² Ğ¸ ÑĞµÑ‚ĞµĞ¹
            if [ "$IS_PR_PREVIEW" == "true" ]; then
              echo "Configuring PR preview environment..."
            
              # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ docker-compose.yml Ğ´Ğ»Ñ preview
              # ĞĞ• Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ¼ĞµĞ½Ğ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² Ğ¸ ÑĞµÑ‚ĞµĞ¹
              sed -i "s/container_name: family-task-manager/container_name: family-task-manager-pr-$PR_NUMBER/g" docker-compose.yml
              sed -i "s/container_name: family-task-postgres/container_name: family-task-postgres-pr-$PR_NUMBER/g" docker-compose.yml
              sed -i "s/family-task-network/family-task-network-pr-$PR_NUMBER/g" docker-compose.yml
              sed -i "s/postgres_data:/postgres_data_pr_$PR_NUMBER:/g" docker-compose.yml
            
              SERVICE_NAME="family-task-manager"
              CONTAINER_NAME="family-task-manager-pr-$PR_NUMBER"
              echo "âœ“ Configured for PR #$PR_NUMBER"
            else
              SERVICE_NAME="family-task-manager"
              CONTAINER_NAME="family-task-manager"
              echo "âœ“ Configured for production"
            fi
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ±ÑĞºĞ°Ğ¿Ğ° Ğ‘Ğ” (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ production)
            if [ "$IS_PRODUCTION" == "true" ]; then
              BACKUP_DIR="/opt/backups/family-task-manager"
              sudo mkdir -p "$BACKUP_DIR"
              sudo chown $USER:$USER "$BACKUP_DIR"
              BACKUP_FILE="$BACKUP_DIR/db_backup_$(date +%Y%m%d_%H%M%S).sql"
              docker exec family-task-postgres pg_dump -U "$POSTGRES_USER" FamilyTaskManager > "$BACKUP_FILE" 2>/dev/null || echo "Warning: Could not create backup"
            fi
            
            # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
            echo "Pulling image: localhost:5000/family-task-manager:$IMAGE_TAG"
            docker pull "localhost:5000/family-task-manager:$IMAGE_TAG"
            
            # ĞŸÑ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° postgres Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° (Ğ¸Ğ·Ğ±ĞµĞ³Ğ°ĞµĞ¼ Docker Hub rate limit)
            echo "Pre-pulling postgres image..."
            docker pull postgres:16-alpine || echo "Warning: Could not pre-pull postgres image"
            
            # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
            echo "Stopping old container..."
            docker compose stop "$SERVICE_NAME" 2>/dev/null || true
            docker compose rm -f "$SERVICE_NAME" 2>/dev/null || true
            
            # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
            echo "Starting new container..."
            docker compose up -d
            
            # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
            sleep 10
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
            echo ""
            echo "Container status:"
            docker compose ps
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¾Ğ³Ğ¾Ğ²
            echo ""
            echo "Recent logs:"
            docker compose logs --tail=50 "$SERVICE_NAME"
            
            # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
            echo ""
            echo "Cleaning up old images..."
            docker image prune -f
            
            # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
            if docker compose ps | grep -q "$CONTAINER_NAME.*Up"; then
              echo ""
              echo "âœ“ Deployment successful!"
              if [ "$IS_PR_PREVIEW" == "true" ]; then
                echo "  PR Preview #$PR_NUMBER is running"
                echo "  Bot: @$BOT_USERNAME"
                echo "  Container: $CONTAINER_NAME"
              fi
            else
              echo ""
              echo "âœ— Deployment failed! Container is not running."
              echo ""
              echo "=== Full container logs ==="
              docker logs "$CONTAINER_NAME" 2>&1 || docker compose logs "$SERVICE_NAME"
              echo ""
              echo "=== Container inspect ==="
              docker inspect "$CONTAINER_NAME" --format='{{.State.Status}}: {{.State.Error}}' 2>/dev/null || echo "Container not found"
              exit 1
            fi

      - name: Comment on PR (if PR preview)
        if: needs.setup.outputs.is_pr_preview == 'true' && needs.setup.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.setup.outputs.pr_number }};
            const imageTag = '${{ needs.setup.outputs.image_tag }}';
            const botUsername = '${{ secrets[needs.setup.outputs.bot_username_secret] }}';
            
            const comment = `## ğŸš€ PR Preview Environment Deployed
            
            Your changes have been deployed to a preview environment!
            
            **Environment Details:**
            - ğŸ¤– **Telegram Bot:** \`@${botUsername}\`
            - ğŸ³ **Container:** \`family-task-manager-pr-${prNumber}\`
            - ğŸ—„ï¸ **Database:** \`FamilyTaskManager_PR_${prNumber}\`
            - ğŸ·ï¸ **Image Tag:** \`${imageTag}\`
            - ğŸ“¦ **Registry:** \`localhost:5000/family-task-manager:${imageTag}\`
            
            **How to test:**
            1. Open Telegram
            2. Find bot \`@${botUsername}\`
            3. Send \`/start\`
            4. Test your changes
            
            **View logs:**
            \`\`\`bash
            ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}
            docker logs family-task-manager-pr-${prNumber} -f
            \`\`\`
            
            **To update:** Push new commits to this PR
            
            **To cleanup:** Close this PR or run cleanup workflow manually
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
