# –¢–µ—Å—Ç—ã Telegram Bot

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç unit-—Ç–µ—Å—Ç—ã –¥–ª—è Telegram Bot –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Family Task Manager.

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è

- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤**: 35+
- **–ü–æ–∫—Ä—ã—Ç–∏–µ**: ~80% –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –±–æ—Ç–∞
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: <5 —Å–µ–∫—É–Ω–¥

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### Models (7 —Ç–µ—Å—Ç–æ–≤)

- `UserSessionTests` - —Ç–µ—Å—Ç—ã –º–æ–¥–µ–ª–∏ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  - –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
  - –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### Services (5 —Ç–µ—Å—Ç–æ–≤)

- `SessionManagerTests` - —Ç–µ—Å—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–µ—Å—Å–∏–π
  - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π
  - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Å—Å–∏–π
  - –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Å—Å–∏–π —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π

### Handlers/Commands (23 —Ç–µ—Å—Ç–∞)

#### FamilyCommandHandlerTests (4 —Ç–µ—Å—Ç–∞)

- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç—å —Å–µ–º—å—é –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ–º–µ–π
- –ü–æ–∫–∞–∑ –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Ä–æ–ª—è–º

#### TasksCommandHandlerTests (5 —Ç–µ—Å—Ç–æ–≤)

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ–º—å–∏
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É
- –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
- Inline-–∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π

#### PetCommandHandlerTests (7 —Ç–µ—Å—Ç–æ–≤)

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ–º—å–∏
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–µ–≤
- –≠–º–æ–¥–∑–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (üòäüò¢)
- –¢–∏–ø—ã –ø–∏—Ç–æ–º—Ü–µ–≤ (üê±üê∂üêπ)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

#### StatsCommandHandlerTests (5 —Ç–µ—Å—Ç–æ–≤)

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ–º—å–∏
- –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
- –ú–µ–¥–∞–ª–∏ –¥–ª—è —Ç–æ–ø-3 (ü•áü•àü•â)
- –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### Handlers (12 —Ç–µ—Å—Ç–æ–≤)

#### CallbackQueryHandlerTests (12 —Ç–µ—Å—Ç–æ–≤)

- –û—Ç–≤–µ—Ç –Ω–∞ callback query
- –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–º—å–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–∞ (–≤—ã–±–æ—Ä —Ç–∏–ø–∞)
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–º—å–∏
- –í–∑—è—Ç–∏–µ –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç—É
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
dotnet test

# –° –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
dotnet test --logger "console;verbosity=detailed"

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ—Å—Ç–æ–≤
dotnet test --filter "FullyQualifiedName~CallbackQueryHandlerTests"

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
dotnet test --filter "FullyQualifiedName~HandleCallbackAsync_ShouldCompleteTask"
```

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

- **xUnit** - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **NSubstitute** - –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (ITelegramBotClient, IMediator)
- **Shouldly** - fluent assertions –¥–ª—è —á–∏—Ç–∞–µ–º—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

## ‚úÖ –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤

### Unit Test - Callback Handler

```csharp
[Fact]
public async Task HandleCallbackAsync_ShouldCompleteTask_WhenTaskCompleteClicked()
{
    // Arrange
    var taskId = Guid.NewGuid();
    var callbackQuery = CreateCallbackQuery($"task_complete_{taskId}");
    
    _mediator.Send(Arg.Any<CompleteTaskCommand>(), Arg.Any<CancellationToken>())
        .Returns(Result.Success());

    // Act
    await _handler.HandleCallbackAsync(_botClient, callbackQuery, ct);

    // Assert
    await _mediator.Received(1).Send(
        Arg.Is<CompleteTaskCommand>(cmd => cmd.TaskId == taskId),
        Arg.Any<CancellationToken>());
}
```

### Unit Test - Session Manager

```csharp
[Fact]
public void ClearInactiveSessions_ShouldRemoveOldSessions()
{
    // Arrange
    var session = _sessionManager.GetSession(12345L);
    session.LastActivity = DateTime.UtcNow.AddHours(-25);

    // Act
    _sessionManager.ClearInactiveSessions();
    var newSession = _sessionManager.GetSession(12345L);

    // Assert
    newSession.ShouldNotBe(session);
}
```

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º ‚úÖ

- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Use Cases
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

### –ß—Ç–æ –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ–º ‚ùå

- –†–µ–∞–ª—å–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã –∫ Telegram API
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –≤ Infrastructure.Tests)
- EF Core (—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –≤ Integration.Tests)

## üìà –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

–¶–µ–ª–µ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:

- **Handlers**: 80%+ ‚úÖ
- **Services**: 90%+ ‚úÖ
- **Models**: 95%+ ‚úÖ

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è:

```bash
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
```

## üîç Troubleshooting

### –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å NullReferenceException

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–º–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –º–æ–∫–æ–≤

### –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –ø–∞–¥–∞—é—Ç –≤ CI

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–π–º–∑–æ–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ UTC)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç race conditions

## üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω AAA (Arrange-Act-Assert):

```csharp
[Fact]
public async Task MethodName_ShouldExpectedBehavior_WhenCondition()
{
    // Arrange - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–∫–æ–≤
    var handler = CreateHandler();
    var input = CreateValidInput();

    // Act - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–≥–æ –º–µ—Ç–æ–¥–∞
    var result = await handler.HandleCommand(input);

    // Assert - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    result.IsSuccess.ShouldBeTrue();
}
```
