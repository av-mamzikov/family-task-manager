# Тестовые сценарии для функциональных тестов (UseCase уровень)

> Этот документ содержит тестовые сценарии для проверки бизнес-логики через прямой вызов use-case-ов (команд и запросов
> через Mediator).
> Тесты выполняются с реальной БД (Testcontainers PostgreSQL), но без слоя Telegram Bot.

## Цель тестов

- ✅ Проверка бизнес-логики и валидации
- ✅ Проверка интеграции с БД (транзакции, constraints)
- ✅ Проверка доменных правил и инвариантов
- ✅ Быстрое выполнение (без HTTP/Bot слоя)

---

## 1. Управление семьёй

### 1.1. Создание семьи

#### TS-UC-001: Создание первой семьи

**Предусловия:** Пользователь зарегистрирован  
**Команда:** `CreateFamilyCommand(userId, familyName, timezone)`  
**Шаги:**

1. Выполнить команду с валидными параметрами
2. Проверить результат выполнения
3. Проверить запись в БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `result.Value` содержит `familyId`
- В БД создана запись `Family` с указанным названием и timezone
- Пользователь добавлен как `FamilyMember` с ролью `Admin`
- `FamilyMember.Points == 0`
- В `ActionHistory` записано событие `FamilyCreated`

**Приоритет:** P0

---

#### TS-UC-002: Создание семьи с некорректным названием

**Предусловия:** Пользователь зарегистрирован  
**Команда:** `CreateFamilyCommand(userId, "Аб", timezone)`  
**Шаги:**

1. Выполнить команду с названием < 3 символов
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.ValidationErrors` содержит ошибку валидации названия
- Семья не создана в БД

**Приоритет:** P1

---

#### TS-UC-003: Создание нескольких семей одним пользователем

**Предусловия:** Пользователь уже создал одну семью  
**Команда:** `CreateFamilyCommand(userId, familyName2, timezone2)`  
**Шаги:**

1. Создать первую семью
2. Создать вторую семью тем же пользователем
3. Проверить записи в БД

**Ожидаемый результат:**

- Обе семьи успешно созданы
- Пользователь является `Admin` в обеих семьях
- `FamilyMember` записи независимы (разные `Points`)

**Приоритет:** P1

---

#### TS-UC-004: Получение списка семей пользователя

**Предусловия:** Пользователь состоит в нескольких семьях  
**Запрос:** `GetUserFamiliesQuery(userId)`  
**Шаги:**

1. Создать 2-3 семьи для пользователя
2. Выполнить запрос
3. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `result.Value` содержит список всех активных семей
- Для каждой семьи указана роль пользователя
- Неактивные семьи (`isActive = false`) не включены

**Приоритет:** P1

---

### 1.2. Управление участниками

#### TS-UC-005: Генерация invite-кода

**Предусловия:** Пользователь является Admin семьи  
**Команда:** `GenerateInviteCodeCommand(familyId, userId, targetRole)`  
**Шаги:**

1. Выполнить команду
2. Проверить результат
3. Проверить запись в БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `result.Value` содержит уникальный `inviteCode`
- В БД создана запись `FamilyInvite` с указанной ролью
- `expiresAt` установлен на +7 дней
- `isActive == true`

**Приоритет:** P0

---

#### TS-UC-006: Присоединение к семье по invite-коду

**Предусловия:** Существует активный invite-код  
**Команда:** `JoinFamilyByInviteCommand(userId, inviteCode)`  
**Шаги:**

1. Сгенерировать invite-код
2. Выполнить команду присоединения
3. Проверить результат и БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- Пользователь добавлен в семью с ролью из invite
- `FamilyInvite.isActive == false` (код использован)
- В `ActionHistory` записано событие `MemberJoined`

**Приоритет:** P0

---

#### TS-UC-007: Присоединение по недействительному коду

**Предусловия:** Invite-код не существует или истёк  
**Команда:** `JoinFamilyByInviteCommand(userId, "INVALID_CODE")`  
**Шаги:**

1. Выполнить команду с несуществующим кодом
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.Errors` содержит сообщение о недействительном коде
- Пользователь не добавлен в семью

**Приоритет:** P1

---

#### TS-UC-008: Удаление участника из семьи

**Предусловия:** Admin удаляет участника  
**Команда:** `RemoveFamilyMemberCommand(familyId, adminUserId, targetUserId)`  
**Шаги:**

1. Создать семью с несколькими участниками
2. Выполнить команду удаления
3. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `FamilyMember.isActive == false` для удалённого участника
- История задач сохранена
- В `ActionHistory` записано событие `MemberRemoved`

**Приоритет:** P1

---

#### TS-UC-009: Попытка удаления участника не-админом

**Предусловия:** Пользователь с ролью Adult или Child  
**Команда:** `RemoveFamilyMemberCommand(familyId, nonAdminUserId, targetUserId)`  
**Шаги:**

1. Выполнить команду от имени не-админа
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.Errors` содержит сообщение о недостаточных правах
- Участник не удалён

**Приоритет:** P1

---

### 1.3. Настройки семьи

#### TS-UC-010: Изменение настроек семьи

**Предусловия:** Admin изменяет настройки  
**Команда:** `UpdateFamilySettingsCommand(familyId, userId, settings)`  
**Шаги:**

1. Выполнить команду с новыми настройками (например, `leaderboardEnabled = false`)
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `Family.settings` обновлены в БД
- В `ActionHistory` записано событие `SettingsUpdated`

**Приоритет:** P2

---

#### TS-UC-011: Изменение временной зоны семьи

**Предусловия:** Admin изменяет timezone  
**Команда:** `UpdateFamilyTimezoneCommand(familyId, userId, newTimezone)`  
**Шаги:**

1. Создать семью с timezone "UTC"
2. Изменить на "Europe/Moscow"
3. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `Family.timezone == "Europe/Moscow"`
- Существующие `TaskInstance` не изменены
- Новые задачи создаются с учётом нового timezone

**Приоритет:** P2

---

#### TS-UC-012: Удаление семьи (soft delete)

**Предусловия:** Admin удаляет семью  
**Команда:** `DeleteFamilyCommand(familyId, userId)`  
**Шаги:**

1. Выполнить команду
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `Family.isActive == false`
- Все связанные данные (задачи, питомцы, участники) сохранены
- В `ActionHistory` записано событие `FamilyDeleted`

**Приоритет:** P2

---

## 2. Питомцы

### 2.1. Создание питомца

#### TS-UC-013: Создание первого питомца

**Предусловия:** Семья создана, питомцев нет  
**Команда:** `CreatePetCommand(familyId, userId, petType, petName)`  
**Шаги:**

1. Выполнить команду с типом "Cat" и именем "Мурзик"
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- Создана запись `Pet` с указанным типом и именем
- Автоматически созданы `TaskTemplate` на основе глобальных шаблонов для кошек
- `Pet.mood == 100`
- В `ActionHistory` записано событие `PetCreated`

**Приоритет:** P0

---

#### TS-UC-014: Создание нескольких питомцев

**Предусловия:** В семье уже есть один питомец  
**Команда:** `CreatePetCommand(familyId, userId, "Dog", "Шарик")`  
**Шаги:**

1. Создать второго питомца другого типа
2. Проверить БД

**Ожидаемый результат:**

- Оба питомца существуют в БД
- У каждого свой набор `TaskTemplate`
- Настроения независимы

**Приоритет:** P1

---

#### TS-UC-015: Валидация имени питомца

**Предусловия:** Создание питомца с некорректным именем  
**Команда:** `CreatePetCommand(familyId, userId, "Cat", "А")`  
**Шаги:**

1. Выполнить команду с именем < 2 символов
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.ValidationErrors` содержит ошибку валидации имени
- Питомец не создан

**Приоритет:** P1

---

### 2.2. Редактирование и удаление питомца

#### TS-UC-016: Изменение имени питомца

**Предусловия:** Питомец существует  
**Команда:** `UpdatePetCommand(petId, userId, newName)`  
**Шаги:**

1. Выполнить команду с новым именем
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `Pet.name` обновлено в БД

**Приоритет:** P2

---

#### TS-UC-017: Удаление питомца с активными задачами

**Предусловия:** У питомца есть активные `TaskTemplate` или `TaskInstance`  
**Команда:** `DeletePetCommand(petId, userId)`  
**Шаги:**

1. Попытаться удалить питомца
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.Errors` содержит сообщение о наличии активных задач
- Питомец не удалён

**Приоритет:** P1

---

#### TS-UC-018: Удаление питомца без активных задач

**Предусловия:** У питомца нет активных задач  
**Команда:** `DeletePetCommand(petId, userId)`  
**Шаги:**

1. Деактивировать все задачи питомца
2. Выполнить команду удаления
3. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- Питомец удалён (soft delete)
- История задач сохранена

**Приоритет:** P2

---

### 2.3. Настроение питомца

#### TS-UC-019: Расчёт настроения без просроченных задач

**Предусловия:** У питомца есть задачи, все выполнены в срок  
**Запрос:** `GetPetMoodQuery(petId)`  
**Шаги:**

1. Создать питомца с задачами
2. Выполнить все задачи в срок
3. Запросить настроение

**Ожидаемый результат:**

- `result.Value.Mood >= 90`
- Нет негативного влияния от просроченных задач

**Приоритет:** P0

---

#### TS-UC-020: Снижение настроения при просроченных задачах

**Предусловия:** У питомца есть просроченная задача  
**Запрос:** `GetPetMoodQuery(petId)`  
**Шаги:**

1. Создать задачу с `dueAt` в прошлом
2. Запросить настроение
3. Проверить расчёт

**Ожидаемый результат:**

- `result.Value.Mood < 100`
- Величина снижения зависит от очков задачи и времени просрочки
- Формула: `mood -= task.points * hoursOverdue * penalty_coefficient`

**Приоритет:** P0

---

#### TS-UC-021: Восстановление настроения после выполнения просроченной задачи

**Предусловия:** Просроченная задача выполнена  
**Шаги:**

1. Создать просроченную задачу
2. Выполнить её
3. Запросить настроение

**Ожидаемый результат:**

- Настроение частично восстановлено
- Негативное влияние задачи прекращено
- `Pet.mood` пересчитано

**Приоритет:** P0

---

## 3. Задачи

### 3.1. Создание задач

#### TS-UC-022: Создание разовой задачи

**Предусловия:** Admin или Adult в семье  
**Команда:** `CreateOneTimeTaskCommand(familyId, userId, title, points, petId, dueAt)`  
**Шаги:**

1. Выполнить команду с валидными параметрами
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- Создан `TaskInstance` с типом `OneTime`
- `status == Active`
- `templateId == null`
- В `ActionHistory` записано событие `TaskCreated`

**Приоритет:** P0

---

#### TS-UC-023: Создание разовой задачи Взрослым

**Предусловия:** Пользователь с ролью Adult  
**Команда:** `CreateOneTimeTaskCommand(...)`  
**Шаги:**

1. Выполнить команду от имени Adult
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == true`
- Задача создана

**Приоритет:** P1

---

#### TS-UC-024: Попытка создания задачи Ребёнком

**Предусловия:** Пользователь с ролью Child  
**Команда:** `CreateOneTimeTaskCommand(...)`  
**Шаги:**

1. Выполнить команду от имени Child
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.Errors` содержит сообщение о недостаточных правах

**Приоритет:** P1

---

#### TS-UC-025: Валидация параметров задачи

**Предусловия:** Создание задачи с некорректными параметрами  
**Команда:** `CreateOneTimeTaskCommand(familyId, userId, "Аб", -5, petId, dueAt)`  
**Шаги:**

1. Выполнить команду с title < 3 символов и points < 1
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.ValidationErrors` содержит ошибки для title и points
- Задача не создана

**Приоритет:** P1

---

#### TS-UC-026: Создание периодической задачи

**Предусловия:** Admin создаёт задачу  
**Команда:** `CreateRecurringTaskCommand(familyId, userId, title, points, petId, cronExpression)`  
**Шаги:**

1. Выполнить команду с cron = "0 0 9 * * ?" (ежедневно в 9:00)
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- Создан `TaskTemplate` с указанным расписанием
- Автоматически создан первый `TaskInstance` с `dueAt` согласно cron
- `TaskInstance.templateId` ссылается на `TaskTemplate`

**Приоритет:** P0

---

#### TS-UC-027: Валидация Quartz Cron Expression

**Предусловия:** Создание периодической задачи  
**Команда:** `CreateRecurringTaskCommand(..., cronExpression: "invalid")`  
**Шаги:**

1. Выполнить команду с некорректным cron
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.ValidationErrors` содержит ошибку валидации cron
- Задача не создана

**Приоритет:** P1

---

### 3.2. Выполнение задач

#### TS-UC-028: Взятие задачи в работу

**Предусловия:** Задача в статусе Active  
**Команда:** `TakeTaskCommand(taskInstanceId, userId)`  
**Шаги:**

1. Выполнить команду
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `TaskInstance.status == InProgress`
- `TaskInstance.assignedTo == userId`
- В `ActionHistory` записано событие `TaskTaken`

**Приоритет:** P0

---

#### TS-UC-029: Попытка взять задачу, уже взятую другим

**Предусловия:** Задача в статусе InProgress у другого участника  
**Команда:** `TakeTaskCommand(taskInstanceId, anotherUserId)`  
**Шаги:**

1. Первый участник берёт задачу
2. Второй участник пытается взять ту же задачу
3. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.Errors` содержит сообщение о том, что задача уже взята
- `TaskInstance.assignedTo` не изменился

**Приоритет:** P1

---

#### TS-UC-030: Выполнение задачи в срок

**Предусловия:** Задача взята, `now() <= dueAt`  
**Команда:** `CompleteTaskCommand(taskInstanceId, userId, comment?)`  
**Шаги:**

1. Выполнить команду
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `TaskInstance.status == Completed`
- `TaskInstance.completedBy == userId`
- `TaskInstance.completedAt` установлено
- `FamilyMember.points` увеличены на полные `task.points`
- `Pet.mood` пересчитано (увеличено)
- В `ActionHistory` записано событие `TaskCompleted`

**Приоритет:** P0

---

#### TS-UC-031: Выполнение задачи с опозданием

**Предусловия:** Задача взята, `now() > dueAt`  
**Команда:** `CompleteTaskCommand(taskInstanceId, userId)`  
**Шаги:**

1. Выполнить команду
2. Проверить начисление очков

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `TaskInstance.status == Completed`
- Начислены очки с коэффициентом `k_late` (например, 0.5)
- `FamilyMember.points` увеличены на `task.points * k_late`
- `Pet.mood` частично восстановлено

**Приоритет:** P1

---

#### TS-UC-032: Автоматическое создание следующего экземпляра

**Предусловия:** Выполнен `TaskInstance` для периодической задачи  
**Шаги:**

1. Выполнить задачу
2. Симулировать срабатывание расписания
3. Проверить БД

**Ожидаемый результат:**

- Создан новый `TaskInstance` с новым `dueAt` согласно cron
- Предыдущий экземпляр остался со статусом `Completed`
- `templateId` у обоих экземпляров одинаковый

**Приоритет:** P1

---

#### TS-UC-033: Предотвращение дубликатов TaskInstance

**Предусловия:** Существует невыполненный `TaskInstance` для `TaskTemplate`  
**Шаги:**

1. Создать периодическую задачу
2. Не выполнять первый экземпляр
3. Симулировать следующее срабатывание расписания
4. Проверить БД

**Ожидаемый результат:**

- Новый `TaskInstance` НЕ создан
- Существует только один активный экземпляр
- Инвариант соблюдён

**Приоритет:** P1

---

### 3.3. Редактирование задач

#### TS-UC-034: Редактирование активной разовой задачи

**Предусловия:** Задача в статусе Active  
**Команда:** `UpdateTaskCommand(taskInstanceId, userId, newTitle, newPoints)`  
**Шаги:**

1. Выполнить команду
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `TaskInstance.title` и `points` обновлены
- В `ActionHistory` записано событие `TaskUpdated`

**Приоритет:** P1

---

#### TS-UC-035: Попытка редактирования выполненной задачи

**Предусловия:** Задача в статусе Completed  
**Команда:** `UpdateTaskCommand(taskInstanceId, userId, newTitle, newPoints)`  
**Шаги:**

1. Выполнить команду
2. Проверить результат

**Ожидаемый результат:**

- `result.IsSuccess == false`
- `result.Errors` содержит сообщение о невозможности редактирования выполненной задачи
- Задача не изменена

**Приоритет:** P1

---

#### TS-UC-036: Редактирование шаблона периодической задачи

**Предусловия:** Существует `TaskTemplate`  
**Команда:** `UpdateTaskTemplateCommand(templateId, userId, newTitle, newPoints, newCron)`  
**Шаги:**

1. Выполнить команду
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `TaskTemplate` обновлён
- Будущие `TaskInstance` создаются с новыми параметрами
- Существующие экземпляры не изменены

**Приоритет:** P1

---

#### TS-UC-037: Деактивация шаблона периодической задачи

**Предусловия:** Существует активный `TaskTemplate`  
**Команда:** `DeactivateTaskTemplateCommand(templateId, userId)`  
**Шаги:**

1. Выполнить команду
2. Проверить БД

**Ожидаемый результат:**

- `result.IsSuccess == true`
- `TaskTemplate.isActive == false`
- Новые `TaskInstance` не создаются
- Существующие экземпляры остаются доступными

**Приоритет:** P2

---

## 4. Лидерборд и очки

### 4.1. Начисление очков

#### TS-UC-038: Начисление очков за выполнение задачи

**Предусловия:** Участник выполняет задачу  
**Шаги:**

1. Получить баланс очков до выполнения
2. Выполнить задачу на 10 очков
3. Получить баланс после

**Ожидаемый результат:**

- `FamilyMember.points` увеличены на 10
- Изменение отражено в БД

**Приоритет:** P0

---

#### TS-UC-039: Очки в контексте семьи

**Предусловия:** Участник состоит в двух семьях  
**Шаги:**

1. Выполнить задачу в семье A
2. Проверить очки в семье A и семье B

**Ожидаемый результат:**

- Очки в семье A увеличены
- Очки в семье B не изменились
- Каждая семья имеет независимый счёт

**Приоритет:** P2

---

#### TS-UC-040: Невозможность ухода в минус

**Предусловия:** У участника 0 очков  
**Шаги:**

1. Попытаться применить штраф (если такая механика будет)
2. Проверить баланс

**Ожидаемый результат:**

- `FamilyMember.points >= 0`
- Минимальное значение = 0

**Приоритет:** P2

---

### 4.2. Лидерборд

#### TS-UC-041: Получение лидерборда

**Предусловия:** В семье несколько участников с разными очками  
**Запрос:** `GetLeaderboardQuery(familyId)`  
**Шаги:**

1. Выполнить запрос
2. Проверить результат

**Ожидаемый результат:**

- `result.Value` содержит список участников
- Сортировка по убыванию очков
- Удалённые участники (`isActive = false`) не включены

**Приоритет:** P0

---

#### TS-UC-042: Лидерборд при выключённой настройке

**Предусловия:** `Family.settings.leaderboardEnabled = false`  
**Запрос:** `GetLeaderboardQuery(familyId)`  
**Шаги:**

1. Выполнить запрос
2. Проверить результат

**Ожидаемый результат:**

- `result.Value` пустой или содержит только текущего пользователя
- Общий рейтинг не отображается
- Очки продолжают начисляться

**Приоритет:** P2

---

## 5. Статистика и история

### 5.1. История действий

#### TS-UC-043: Запись событий в историю

**Предусловия:** Выполняются различные действия  
**Шаги:**

1. Создать семью
2. Создать задачу
3. Выполнить задачу
4. Запросить историю

**Запрос:** `GetActionHistoryQuery(familyId, limit: 100)`  
**Ожидаемый результат:**

- Все события записаны в `ActionHistory`
- Каждое событие содержит: `actionType`, `description`, `metadata`, `timestamp`
- События отображаются в хронологическом порядке (DESC)

**Приоритет:** P1

---

#### TS-UC-044: Ограничение количества событий

**Предусловия:** В семье > 100 событий  
**Запрос:** `GetActionHistoryQuery(familyId, limit: 100)`  
**Шаги:**

1. Создать > 100 событий
2. Выполнить запрос
3. Проверить результат

**Ожидаемый результат:**

- Возвращено не более 100 событий
- Более старые события сохранены в БД, но не возвращены

**Приоритет:** P2

---

#### TS-UC-045: Фильтрация истории по участнику

**Предусловия:** В семье несколько участников  
**Запрос:** `GetActionHistoryQuery(familyId, userId: specificUserId)`  
**Шаги:**

1. Выполнить запрос с фильтром по участнику
2. Проверить результат

**Ожидаемый результат:**

- Возвращены только события, связанные с указанным участником
- События других участников не включены

**Приоритет:** P2

---

#### TS-UC-046: Фильтрация истории по периоду

**Предусловия:** Есть события за разные периоды  
**Запрос:** `GetActionHistoryQuery(familyId, fromDate, toDate)`  
**Шаги:**

1. Выполнить запрос с фильтром по датам
2. Проверить результат

**Ожидаемый результат:**

- Возвращены только события за указанный период
- События вне периода не включены

**Приоритет:** P2

---

## 6. Права доступа

### 6.1. Проверка ролей

#### TS-UC-047: Доступ Admin ко всем функциям

**Предусловия:** Пользователь с ролью Admin  
**Шаги:**

1. Попытаться выполнить все административные команды
2. Проверить результаты

**Ожидаемый результат:**

- Все команды выполнены успешно:
    - Создание/удаление семьи
    - Управление участниками
    - Создание/редактирование/удаление задач
    - Создание/удаление питомцев
    - Изменение настроек

**Приоритет:** P1

---

#### TS-UC-048: Ограничения роли Adult

**Предусловия:** Пользователь с ролью Adult  
**Шаги:**

1. Попытаться создать разовую задачу — успешно
2. Попытаться создать периодическую задачу — заблокировано
3. Попытаться удалить участника — заблокировано

**Ожидаемый результат:**

- Разовая задача создана
- Периодическая задача не создана (`result.IsSuccess == false`)
- Участник не удалён (`result.IsSuccess == false`)

**Приоритет:** P1

---

#### TS-UC-049: Ограничения роли Child

**Предусловия:** Пользователь с ролью Child  
**Шаги:**

1. Попытаться создать задачу — заблокировано
2. Попытаться изменить настройки — заблокировано
3. Выполнить задачу — успешно
4. Просмотреть свои очки — успешно

**Ожидаемый результат:**

- Задача не создана
- Настройки не изменены
- Задача выполнена
- Очки отображены

**Приоритет:** P1

---

## 7. Граничные случаи

### 7.1. Конкурентный доступ

#### TS-UC-050: Одновременное взятие задачи двумя участниками

**Предусловия:** Два участника одновременно берут одну задачу  
**Шаги:**

1. Запустить две параллельные команды `TakeTaskCommand`
2. Проверить результат

**Ожидаемый результат:**

- Только одна команда выполнена успешно
- Вторая команда получила ошибку
- `TaskInstance.assignedTo` установлен только для одного участника
- Нет дублирования статуса `InProgress`

**Приоритет:** P1

---

#### TS-UC-051: Одновременное выполнение задачи

**Предусловия:** Два участника пытаются выполнить одну задачу  
**Шаги:**

1. Запустить две параллельные команды `CompleteTaskCommand`
2. Проверить результат

**Ожидаемый результат:**

- Только одна команда выполнена успешно
- Очки начислены только один раз
- `TaskInstance.status == Completed` установлен один раз

**Приоритет:** P1

---

### 7.2. Валидация данных

#### TS-UC-052: Обработка некорректного ввода

**Предусловия:** Создание сущностей с некорректными данными  
**Шаги:**

1. Попытаться создать семью с названием > 100 символов
2. Попытаться создать задачу с отрицательными очками
3. Проверить результаты

**Ожидаемый результат:**

- Все команды вернули `result.IsSuccess == false`
- `result.ValidationErrors` содержат понятные сообщения
- Данные не сохранены в БД

**Приоритет:** P2

---

## Примечания

1. **Изоляция тестов:** Каждый тест выполняется в отдельной транзакции с чистой БД
2. **Testcontainers:** Используется PostgreSQL контейнер для реальной БД
3. **Fixtures:** Тестовые данные создаются через use-case команды
4. **Идемпотентность:** Тесты независимы и могут выполняться в любом порядке
5. **Assertions:** Проверяются как результаты команд, так и состояние БД

---

## Приоритизация

### P0 (Критичные):

- TS-UC-001, TS-UC-005, TS-UC-006, TS-UC-013, TS-UC-019, TS-UC-020, TS-UC-021
- TS-UC-022, TS-UC-026, TS-UC-028, TS-UC-030, TS-UC-038, TS-UC-041

### P1 (Высокий):

- TS-UC-002, TS-UC-003, TS-UC-004, TS-UC-007, TS-UC-008, TS-UC-009
- TS-UC-014, TS-UC-015, TS-UC-017, TS-UC-023, TS-UC-024, TS-UC-025, TS-UC-027
- TS-UC-029, TS-UC-031, TS-UC-032, TS-UC-033, TS-UC-034, TS-UC-035, TS-UC-036
- TS-UC-043, TS-UC-047, TS-UC-048, TS-UC-049, TS-UC-050, TS-UC-051

### P2 (Средний):

- TS-UC-010, TS-UC-011, TS-UC-012, TS-UC-016, TS-UC-018, TS-UC-037
- TS-UC-039, TS-UC-040, TS-UC-042, TS-UC-044, TS-UC-045, TS-UC-046, TS-UC-052
